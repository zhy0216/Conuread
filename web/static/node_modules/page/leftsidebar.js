var $ = require("jquery");
var swig = require("swig");
var signal = require('signal').createSignal(); 

var FeedSite = require("model/feedsite").FeedSite;
var FeedSiteList = require("model/feedsite").FeedSiteList;


var SubChooser = function(item){
    var self = this;

    this.targetDom = $("#subsribe-chooser");
    this.originalTargetDom = this.targetDom.clone();

    this.currentActiveItem = item || null;
    this.feedSiteList = new FeedSiteList();

    this.feedSiteListTemplate = swig.compile($("#feedSiteListTemplate").html());


    this.init = function(){
        console.log("SubChooser start");
        this.eventBind();
        this._setFeedSiteListData(feedSiteListData);
        this.render();
        self.activeItem($("#sidebar [feedsiteid='" + curActiveFeedSiteId + "']"))
    }

    this.feedReadAction = function(feed){
        var feedsite = self.feedSiteList.getFeedSiteById(feed.feedsiteid);
        feedsite.unreadCount--;
        self.clearTarget();
        self.render();
        self._reactive();
    }

    this.clearTarget = function(){
        this.targetDom.html(this.originalTargetDom.html());
    }

    this.activeItem = function(dom){
        if(this.currentActiveItem == null){
            this.currentActiveItem = $(".sub-btn").first();
            this.currentActiveItem.addClass("active");
        }
        self.currentActiveItem.removeClass("active");
        dom.addClass("active");
        self.currentActiveItem = dom;
    }


    this.eventBind = function (){
        console.log("leftsidebar bind");
        var _timeController = null;
        $(document).on("click", "#sidebar [feedsiteid]", function(){
            var $this = $(this);
            var feedsiteid = $this.attr("feedsiteid");
            self.activeItem($this);
            signal.publish("feedsite-fetch")(feedsiteid);
        })

        $("#add-resource-btn").on("click", function(e){
            e.preventDefault();
            clearTimeout(_timeController);
            console.log("show");
            $(this).popover('show');
            _timeController = setTimeout(function(){
              $("#sidebar .popover").unbind("clickoutside").bind("clickoutside", function(){
                    $("#add-resource-btn").popover('hide');
                    $(this).unbind("clickoutside");
                })
            }, 200)
        })

        $(document).on("keypress", "#sidebar input", function(e){
            var $this = $(this);
            if(e.which == 13){
                $("#add-resource-btn").popover('hide');
                $.post("/api/feedsite/sub", {
                    url:$this.val()
                }).done(function(data){
                    if(data.rcode == 200){
                        console.log(data);
                        var feedSite = new FeedSite();
                        feedSite.init(data.feedsite)
                        self.feedSiteList.addFeedSite(feedSite);
                        self.clearTarget();
                        self.render();
                        self.activeItem($("#sidebar [feedsiteid='" + feedSite.id + "']"))
                        signal.publish("feedsite-fetch")(feedSite.id);
                    }
                });
            }
        })

    }

    this._setFeedSiteListData = function(feedSiteListData){
         $.each(feedSiteListData, function(i, jsonData){
            var feedSite = new FeedSite();
            feedSite.init(jsonData)
            self.feedSiteList.addFeedSite(feedSite);
        });
    }

    this.getCurFeedSite = function(){
        var curFeedSiteid = this.currentActiveItem.attr("feedsiteid");
        return self.feedSiteList.getFeedSiteById(curFeedSiteid);
    }

    this.render = function(){
        var content = this.feedSiteList.render(this.feedSiteListTemplate);
        this.targetDom.append(content);
        $("#all-item-btn .counter").html(this.feedSiteList.totalUnreadCount());
        // this._reactive();
        return this;
    }

    this._reactive = function(){ // only call after render
        var feedsiteid = this.currentActiveItem.attr("feedsiteid");
        self.activeItem($("#sidebar [feedsiteid='" + feedsiteid + "']"))
    }



} 

exports.SubChooser = SubChooser;
